steps:

# Azure CLI; KV Secrets
- task: AzureCLI@2
  displayName: 'Get hosted agent IP and add to KV whitelist'
  inputs:
    # Name of the ARM connection
    azureSubscription: ${{ parameters.azureSubscription }}
    # All Platforms
    scriptType: 'pscore' 
    scriptLocation: 'inlineScript'
    inlineScript: |
      $key1 = $(az keyvault secret show --name graph-appregsecret --vault-name ${{ parameters.kvName }}) | ConvertFrom-JSON
      $key2 = $(az keyvault secret show --name azuresql-appregsecret --vault-name ${{ parameters.kvName }}) | ConvertFrom-JSON
      Write-Host "##vso[task.setvariable variable=graph-appregsecret;issecret=true;isreadonly=true;]$($key1.value)"
      Write-Host "##vso[task.setvariable variable=azuresql-appregsecret;issecret=true;isreadonly=true;]$($key2.value)"

# Azure Container Apps ARM template deployment
- task: AzureResourceGroupDeployment@2
  displayName: 'Deploy Container App'
  inputs:
    azureSubscription: ${{ parameters.azureSubscription }}
    action: 'Create Or Update Resource Group' # Options: create Or Update Resource Group, select Resource Group, start, stop, stopWithDeallocate, restart, delete, deleteRG
    resourceGroupName: ${{ parameters.resourceGroup }}
    location: 'westus2' # Required when action = Create Or Update Resource Group
    templateLocation: 'Linked artifact' # Options: linked Artifact, uRL Of The File
    csmFile: '$(System.DefaultWorkingDirectory)/Server/containerAppARM.json' # Required when  TemplateLocation = Linked Artifact
    csmParametersFile: '$(System.DefaultWorkingDirectory)/Server/containerAppARM.parameters.json' # Optional
    overrideParameters: >
      -azuresql-appregsecret $($(azuresql-appregsecret))
      -graph-appregsecret $($(graph-appregsecret)) 
      -container-image '${{ format('docker.io/stephansantos/hearye-docker:v1.{0}', parameters.buildId) }}'
    # NOTE - $($(parameters.keyVaultAppRegSecret)) is taking the value of a variable (the secret's name) 
    #        and placing it inside variable brackets to call on a variable with that name and get the secret's value
    deploymentMode: 'Incremental' # Options: incremental, complete, validation